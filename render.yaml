services:
  # Main Heady Manager Service (Node.js + Python hybrid)
  - type: web
    name: heady-manager
    runtime: node
    buildCommand: npm install && pip install -r requirements.txt
    startCommand: node heady-manager.js
    healthCheckPath: /api/health
    envVars:
      - fromGroup: heady-shared-secrets
      - key: PORT
        value: "3300"
      - key: NODE_ENV
        value: "production"
      - key: HEADY_TRUST_PROXY
        value: "true"
      - key: HEADY_ADMIN_ROOT
        value: "/opt/render/project/src"
      - key: HEADY_ADMIN_ALLOWED_PATHS
        value: "/opt/render/project/src"
      - key: HEADY_ADMIN_MAX_BYTES
        value: "524288"
      - key: HEADY_ADMIN_BUILD_SCRIPT
        value: "/opt/render/project/src/consolidated_builder.py"
      - key: HEADY_ADMIN_AUDIT_SCRIPT
        value: "/opt/render/project/src/admin_console.py"
      - key: HEADY_PYTHON_BIN
        value: "python3"
      - key: HEADY_PY_WORKER_TIMEOUT_MS
        value: "90000"
      - key: HEADY_MCP_SERVER_TIMEOUT_MS
        value: "30000"
      - key: HEADY_MCP_MAX_CONCURRENT_REQUESTS
        value: "10"
      - key: HEADY_LOG_LEVEL
        value: "info"
      - key: HEADY_LOG_FORMAT
        value: "json"
      - key: HEADY_RATE_LIMIT_WINDOW_MS
        value: "60000"
      - key: HEADY_RATE_LIMIT_MAX
        value: "120"
      - key: HF_MAX_CONCURRENCY
        value: "4"
      - key: HEADY_PY_MAX_CONCURRENCY
        value: "2"
      - key: HEADY_QA_BACKEND
        value: "auto"
      - key: HEADY_QA_MAX_NEW_TOKENS
        value: "256"
      - key: HF_TEXT_MODEL
        value: "gpt2"
      - key: HF_EMBED_MODEL
        value: "sentence-transformers/all-MiniLM-L6-v2"
      - key: HEADY_CORS_ORIGINS
        value: "https://heady-systems.onrender.com,https://heady-backend.onrender.com,https://heady-frontend.onrender.com"
      - key: REMOTE_GPU_HOST
        value: "${REMOTE_GPU_HOST}"
      - key: REMOTE_GPU_PORT
        value: "${REMOTE_GPU_PORT}"
      - key: GPU_MEMORY_LIMIT
        value: "${GPU_MEMORY_LIMIT}"
      - key: ENABLE_GPUDIRECT
        value: "${ENABLE_GPUDIRECT}"
      - key: DATABASE_URL
        value: "${DATABASE_URL}"
      - key: HF_TOKEN
        value: "${HF_TOKEN}"
      - key: HEADY_API_KEY
        value: "${HEADY_API_KEY}"
      - key: GITHUB_APP_ID
        value: "${GITHUB_APP_ID}"
      - key: GITHUB_APP_PRIVATE_KEY
        value: "${GITHUB_APP_PRIVATE_KEY}"
      - key: GITHUB_APP_WEBHOOK_SECRET
        value: "${GITHUB_APP_WEBHOOK_SECRET}"

  # Backend API Service
  - type: web
    name: heady-backend
    runtime: node
    rootDir: backend
    buildCommand: npm install
    startCommand: npm start
    healthCheckPath: /api/health
    envVars:
      - fromGroup: heady-shared-secrets
      - key: PORT
        value: "4000"
      - key: NODE_ENV
        value: "production"
      - key: DATABASE_URL
        value: "${DATABASE_URL}"
      - key: CORS_ORIGINS
        value: "https://heady-frontend.onrender.com,https://heady-systems.onrender.com"

  # Frontend Static Site
  - type: web
    name: heady-frontend
    runtime: static
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: ./dist
    envVars:
      - key: NODE_ENV
        value: "production"
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

databases:
  - name: heady-postgres
    databaseName: heady_db
    user: heady_user
    plan: starter
